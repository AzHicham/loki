FROM rust:buster as builder
RUN apt-get update && apt-get install -y git

# build and install gtfs2ntfs
RUN git clone https://github.com/CanalTP/transit_model
RUN cd transit_model && cargo install --path gtfs2ntfs

FROM debian:buster-slim

# copy package from context inside the docker
COPY ./tmp/navitia-ed_*.deb /
COPY ./tmp/navitia/source/ /navitia/source/
COPY ./docker/bina.sh /bina.sh

# install dependencies
RUN apt-get update
RUN apt-get install -y python3 python3-pip libpq-dev jq git

# install navitia-ed package
RUN apt-get install -y /navitia-ed_*.deb

# install eitri requirements
RUN pip3 install --no-cache-dir -r /navitia/source/eitri/requirements.txt

# copy gtfs2ntfs 
COPY --from=builder /usr/local/cargo/bin/gtfs2ntfs /usr/local/bin/gtfs2ntfs

RUN chmod +x /bina.sh

VOLUME /storage

CMD ["/bina.sh"]




